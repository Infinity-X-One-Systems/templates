name: CI — Infinity Template Library

on:
  push:
    branches: [main, "copilot/**"]
  pull_request:
    branches: [main]

jobs:
  # ── Engine Tests ────────────────────────────────────────────────────────────
  engine:
    name: Composition Engine Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: engine
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip
          cache-dependency-path: engine/requirements*.txt
      - run: pip install -r requirements.txt -r requirements-dev.txt
      - run: pytest --cov=scripts --cov-report=xml -q

  # ── FastAPI Core Tests ──────────────────────────────────────────────────────
  fastapi-core:
    name: FastAPI Core Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: core/api-fastapi
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip
          cache-dependency-path: core/api-fastapi/requirements*.txt
      - run: pip install -r requirements.txt -r requirements-dev.txt
      - run: pytest --cov=app --cov-report=xml -q

  # ── AI Agent Tests ──────────────────────────────────────────────────────────
  ai-agents:
    name: AI Agent Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        agent: [research-agent, builder-agent, financial-agent, real-estate-agent, orchestrator]
    defaults:
      run:
        working-directory: ai/${{ matrix.agent }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip
          cache-dependency-path: ai/${{ matrix.agent }}/requirements*.txt
      - run: pip install -r requirements.txt -r requirements-dev.txt
      - run: pytest -q

  # ── Manifest Schema Validation ──────────────────────────────────────────────
  manifest-validation:
    name: Validate Example Manifests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - run: pip install jsonschema==4.23.0
      - name: Validate example manifest
        run: |
          python -c "
          import json, jsonschema
          with open('engine/schema/manifest.schema.json') as sf:
              schema = json.load(sf)
          with open('engine/schema/system-manifest.example.json') as mf:
              manifest = json.load(mf)
          jsonschema.validate(manifest, schema)
          print('Example manifest schema validation: PASSED')
          "

  # ── Docker Build Checks ─────────────────────────────────────────────────────
  docker-build:
    name: Docker Build Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build FastAPI Docker image
        run: docker build -t test-fastapi core/api-fastapi
      - name: Build Research Agent Docker image
        run: docker build -t test-research-agent ai/research-agent
